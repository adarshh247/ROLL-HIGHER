<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roll Higher (Multiplayer)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Dark Slate Gray background */
        }
        /* ... [All your other CSS styles remain the same] ... */
        .dice {
            font-size: 7rem;
            line-height: 1;
            transition: transform 0.2s ease-out;
            text-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .dice-container { min-height: 120px; }
        .score-over { display: flex; gap: 8px; justify-content: center; }
        .p1score-ball, .p2score-ball {
            width: 40px; height: 40px; display: flex; align-items: center;
            justify-content: center; border-radius: 50%; background-color: #374151;
            color: #f3f4f6; font-size: 1.125rem; font-weight: 600;
            transition: all 0.3s ease; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .p1score-ball.filled, .p2score-ball.filled {
            background-color: #f9fafb; color: #111827; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .p1score-ball.boundary-6, .p2score-ball.boundary-6 {
            background-color: #10b981; color: white; font-weight: bold; transform: scale(1.1);
        }
        .p1score-ball.boundary-4, .p2score-ball.boundary-4 {
            background-color: #3b82f6; color: white; font-weight: bold; transform: scale(1.1);
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .blinking { animation: blink 1s infinite; }
        
        #player-identity {
            position: fixed; top: 0; left: 0; right: 0; padding: 8px;
            text-align: center; font-weight: 600; z-index: 50;
        }

        /* Helper class to hide/show elements */
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 text-gray-200">

    <!-- This div will show the player their assignment -->
    <div id="player-identity"></div>

    <!-- 
      NEW: Lobby Container
      This will show first.
    -->
    <div id="lobby-container" class="w-full max-w-md bg-gray-900 shadow-2xl rounded-xl p-8 space-y-6 border border-gray-700">
        <h1 class="text-4xl font-extrabold text-teal-400 text-center">Roll Higher</h1>
        <p id="lobby-message" class="text-center text-lg text-yellow-400 min-h-[28px]"></p>
        
        <div class="space-y-4">
            <button id="create-room-button" class="w-full px-6 py-3 text-xl font-bold text-white bg-teal-600 rounded-full shadow-lg hover:bg-teal-500 transition duration-150 transform hover:scale-105">
                Create Room
            </button>
            <div id="room-display" class="hidden text-center space-y-2">
                <p class="text-lg">Room created! Share this ID:</p>
                <div class="bg-gray-800 text-white text-3xl font-bold tracking-widest p-3 rounded-lg">
                    <span id="room-id-text"></span>
                </div>
                <p class="text-gray-400">Waiting for Player 2 to join...</p>
            </div>
        </div>

        <div class="relative">
            <div class="absolute inset-0 flex items-center">
                <div class="w-full border-t border-gray-600"></div>
            </div>
            <div class="relative flex justify-center text-sm">
                <span class="px-2 bg-gray-900 text-gray-400">OR</span>
            </div>
        </div>

        <div class="space-y-3">
            <input type="text" id="room-id-input" placeholder="Enter Room ID" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg text-white text-lg text-center tracking-widest focus:outline-none focus:ring-2 focus:ring-teal-500">
            <button id="join-room-button" class="w-full px-6 py-3 text-xl font-bold text-white bg-blue-600 rounded-full shadow-lg hover:bg-blue-500 transition duration-150 transform hover:scale-105">
                Join Room
            </button>
        </div>
    </div>

    <!-- 
      Your Original Game Container
      This will be hidden until the game starts.
    -->
    <div id="game-container" class="hidden w-full max-w-2xl bg-gray-900 shadow-2xl rounded-xl p-8 space-y-8 border border-gray-700">
        
        <header class="text-center">
            <h1 class="text-4xl font-extrabold text-teal-400 mb-2">ðŸŽ² Roll Higher ðŸŽ²</h1>
        </header>

        <!-- Current Score and Round Info -->
        <div class="flex justify-between items-center text-center bg-gray-800 p-4 rounded-lg shadow-inner">
            <div class="flex-1">
                <p class="text-sm uppercase font-medium text-gray-400">P1 Wins</p>
                <p id="score-p1" class="text-4xl font-bold text-yellow-400">0</p>
            </div>
            <div class="mx-6">
                <p class="text-sm uppercase font-medium text-gray-400">Round</p>
                <p id="current-round" class="text-4xl font-bold text-white">1 / 3</p>
            </div>
            <div class="flex-1">
                <p class="text-sm uppercase font-medium text-gray-400">P2 Wins</p>
                <p id="score-p2" class="text-4xl font-bold text-rose-400">0</p>
            </div>
        </div>

        <!-- Player Dice Rolls Area -->
        <div class="flex justify-around text-center mt-6">
            
            <!-- Player 1 Card -->
            <div id="player-1-card" class="bg-gray-700 p-6 rounded-xl shadow-lg w-5/12 transition duration-300 ease-in-out">
                <h2 class="text-2xl font-bold mb-3 text-yellow-400">Player 1</h2>
                <div id="dice-p1-container" class="dice-container flex items-center justify-center">
                    <div id="dice-p1" class="dice text-white">?</div>
                </div>
                <div class="score-over mb-4">
                    <div class="p1score-ball" data-ball="0"></div>
                    <div class="p1score-ball" data-ball="1"></div>
                    <div class="p1score-ball" data-ball="2"></div>
                </div>
            </div>

            <div class="w-1/12 flex items-center justify-center">
                <span class="text-4xl text-gray-400 font-extrabold">VS</span>
            </div>
            
            <!-- Player 2 Card -->
            <div id="player-2-card" class="bg-gray-700 p-6 rounded-xl shadow-lg w-5/12 transition duration-300 ease-in-out">
                <h2 class="text-2xl font-bold mb-3 text-rose-400">Player 2</h2>
                <div id="dice-p2-container" class="dice-container flex items-center justify-center">
                    <div id="dice-p2" class="dice text-white">?</div>
                </div>
                <div class="score-over mb-4">
                    <div class="p2score-ball" data-ball="0"></div>
                    <div class="p2score-ball" data-ball="1"></div>
                    <div class="p2score-ball" data-ball="2"></div>
                </div>
            </div>

        </div>

        <!-- Action Button -->
        <div class="flex justify-center pt-4">
            <button id="roll-button"
                class="px-8 py-3 text-xl font-bold text-white bg-teal-600 rounded-full shadow-lg hover:bg-teal-500 transition duration-150 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50">
                Roll Dice
            </button>
            <button id="restart-button"
                class="hidden px-8 py-3 text-xl font-bold text-white bg-red-600 rounded-full shadow-lg hover:bg-red-500 transition duration-150 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50">
                Play Again
            </button>
        </div>
        
        <!-- Message Button -->
        <div>
            <p id="game-message" class="text-xl font-semibold text-gray-200 min-h-[30px] text-center">Connecting to server...</p>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- Client-Side Socket.io Logic ---
        
        const socket = io();
        let myPlayerNumber = 0;

        // --- DOM Elements (Lobby) ---
        const $lobbyContainer = document.getElementById('lobby-container');
        const $lobbyMessage = document.getElementById('lobby-message');
        const $createRoomButton = document.getElementById('create-room-button');
        const $roomDisplay = document.getElementById('room-display');
        const $roomIdText = document.getElementById('room-id-text');
        const $roomIdInput = document.getElementById('room-id-input');
        const $joinRoomButton = document.getElementById('join-room-button');

        // --- DOM Elements (Game) ---
        const $gameContainer = document.getElementById('game-container');
        const $scoreP1 = document.getElementById('score-p1');
        const $scoreP2 = document.getElementById('score-p2');
        const $currentRound = document.getElementById('current-round');
        const $gameMessage = document.getElementById('game-message');
        const $diceP1 = document.getElementById('dice-p1');
        const $diceP2 = document.getElementById('dice-p2');
        const $rollButton = document.getElementById('roll-button');
        const $restartButton = document.getElementById('restart-button');
        const $player1Card = document.getElementById('player-1-card');
        const $player2Card = document.getElementById('player-2-card');
        const $playerIdentity = document.getElementById('player-identity');
        const p1ballElements = document.querySelectorAll('.p1score-ball');
        const p2ballElements = document.querySelectorAll('.p2score-ball');

        /**
         * Updates all UI elements based on the gameState received from the server.
         */
        function updateUI(gameState) {
            // ... [This function is identical to your previous one] ...
            $scoreP1.textContent = gameState.scores[0];
            $scoreP2.textContent = gameState.scores[1];
            $currentRound.textContent = `${gameState.currentRound} / 3`;
            $diceP1.textContent = gameState.roundDice[0] > 0 ? gameState.diceSymbols[gameState.roundDice[0] - 1] : '?';
            $diceP2.textContent = gameState.roundDice[1] > 0 ? gameState.diceSymbols[gameState.roundDice[1] - 1] : '?';
            
            p1ballElements.forEach((ball, index) => updateBall(ball, gameState.p1RoundRolls[index]));
            p2ballElements.forEach((ball, index) => updateBall(ball, gameState.p2RoundRolls[index]));

            $player1Card.classList.remove('blinking');
            $player2Card.classList.remove('blinking');
            $player1Card.classList.toggle('bg-gray-800', gameState.currentPlayer !== 1 || gameState.isGameOver);
            $player2Card.classList.toggle('bg-gray-800', gameState.currentPlayer !== 2 || gameState.isGameOver);
            $player1Card.classList.toggle('bg-gray-700', gameState.currentPlayer === 1 && !gameState.isGameOver);
            $player2Card.classList.toggle('bg-gray-700', gameState.currentPlayer === 2 && !gameState.isGameOver);

            if (!gameState.isGameOver) {
                if (gameState.currentPlayer === 1) $player1Card.classList.add('blinking');
                else if (gameState.currentPlayer === 2) $player2Card.classList.add('blinking');
            }
            
            if (gameState.isGameOver) {
                $rollButton.classList.add('hidden');
                $restartButton.classList.remove('hidden');
            } else {
                $rollButton.classList.remove('hidden');
                $restartButton.classList.add('hidden');
                const isMyTurn = (myPlayerNumber === gameState.currentPlayer);
                $rollButton.disabled = !isMyTurn;
                $rollButton.textContent = isMyTurn ? "Roll Dice" : `Waiting for Player ${gameState.currentPlayer}`;
                $rollButton.classList.toggle('opacity-50', !isMyTurn);
                $rollButton.classList.toggle('cursor-not-allowed', !isMyTurn);
            }
            $gameMessage.textContent = gameState.message;
        }
        
        function updateBall(ballElement, roll) {
            ballElement.textContent = '';
            ballElement.classList.remove('filled', 'boundary-4', 'boundary-6');
            if (roll) {
                ballElement.textContent = roll;
                ballElement.classList.add('filled');
                if (roll === 4) ballElement.classList.add('boundary-4');
                else if (roll === 6) ballElement.classList.add('boundary-6');
            }
        }

        // --- Socket.io Event Listeners ---

        // Server tells us what our player number is
        socket.on('playerAssignment', (playerNum) => {
            myPlayerNumber = playerNum;
            if (playerNum === 1) {
                $playerIdentity.textContent = "You are Player 1 (Yellow)";
                $playerIdentity.className = "bg-yellow-400 text-gray-900";
            } else if (playerNum === 2) {
                $playerIdentity.textContent = "You are Player 2 (Rose)";
                $playerIdentity.className = "bg-rose-400 text-gray-900";
            } else {
                $playerIdentity.textContent = "You are spectating";
                $playerIdentity.className = "bg-gray-400 text-gray-900";
            }
        });

        // Server sends a full game state update
        socket.on('updateState', (serverGameState) => {
            updateUI(serverGameState);
        });
        
        // NEW: Server confirms room creation
        socket.on('roomCreated', (roomId) => {
            $roomIdText.textContent = roomId;
            $roomDisplay.classList.remove('hidden');
            // Hide the create/join buttons
            $createRoomButton.classList.add('hidden');
            $joinRoomButton.parentElement.classList.add('hidden');
            $lobbyMessage.textContent = '';
        });
        
        // NEW: Server says the game is starting (P2 has joined)
        socket.on('gameStart', (serverGameState) => {
            $lobbyContainer.classList.add('hidden'); // Hide lobby
            $gameContainer.classList.remove('hidden'); // Show game
            updateUI(serverGameState); // Populate game with initial state
        });
        
        // NEW: Server sends an error message (e.g., room full)
        socket.on('errorMessage', (message) => {
            $lobbyMessage.textContent = message;
        });


        // --- Client-Side Event Emitters ---
        
        // --- Lobby Emitters ---
        $createRoomButton.addEventListener('click', () => {
            $lobbyMessage.textContent = '';
            socket.emit('createRoom');
        });
        
        $joinRoomButton.addEventListener('click', () => {
            const roomId = $roomIdInput.value.trim();
            if (roomId) {
                $lobbyMessage.textContent = '';
                socket.emit('joinRoom', roomId);
            } else {
                $lobbyMessage.textContent = 'Please enter a Room ID.';
            }
        });

        // --- Game Emitters ---
        $rollButton.addEventListener('click', () => {
            if ($rollButton.disabled) return;
            socket.emit('roll');
            const diceEl = (myPlayerNumber === 1) ? $diceP1 : $diceP2;
            diceEl.style.transform = 'rotateY(360deg)';
            setTimeout(() => diceEl.style.transform = 'rotateY(0deg)', 200);
        });

        $restartButton.addEventListener('click', () => {
            socket.emit('restart');
        });

    </script>
</body>
</html>
